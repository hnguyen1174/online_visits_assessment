---
title: "Process Data and EDA"
---

## 1. Load Libraries

```{r load_library}
library(tidyverse)
library(here)
library(lubridate)
library(janitor)
library(zoo)
library(ggthemes)

library(forecast)
library(stargazer)
library(data.table)
library(tableone)
library(lattice)
library(pwr)
library(rcompanion)
library(scales)
library(plm)
library(readxl)
library(MatchIt)
library(lfe)
library(Synth)
library(gsynth)
library(panelView)
library(CausalImpact)
```

```{r devtools_loadall}
devtools::load_all()
```

## 2. Load and Process Data

```{r load_data}
metrics <- readr::read_csv(file.path(here::here(), 'data/data.csv'))
property <- readr::read_csv(file.path(here::here(), 'data/property_info.csv'))
```

```{r process_data}
metrics <- metrics %>% 
  clean_names() %>% 
  replace(is.na(.), 0)

property <- property %>% 
  clean_names() %>% 
  dplyr::rename(online_visits = virtual_reality_launched) %>% 
  mutate(avg_review_rating_num = case_when(
    avg_review_rating == "< 2.5" ~ (0 + 2.5)/2,
    avg_review_rating == "2.5 - 3" ~ (2.5 + 3)/2,
    avg_review_rating == "3.1 - 3.5" ~ (3.1 + 3.5)/2,
    avg_review_rating == "3.6 - 4" ~ (3.6 + 4)/2,
    avg_review_rating == "4.1 - 4.25" ~ (4.1 + 4.25)/2,
    avg_review_rating == "4.26 - 4.50" ~ (4.26 + 4.5)/2,
    avg_review_rating == "4.51 - 4.75" ~ (4.51 + 4.75)/2,
    avg_review_rating == "4.76+" ~ (4.76 + 5)/2,
    avg_review_rating == "No Reviews" ~ 0 
  )) %>% 
  mutate(number_of_reviews_on_the_property_num = case_when(
    number_of_reviews_on_the_property == "20+"  ~ 20,
    number_of_reviews_on_the_property == "6 to 11" ~ (6 + 11)/2,
    number_of_reviews_on_the_property == "5" ~ 5, 
    number_of_reviews_on_the_property == "12 to 19" ~ (12 + 19)/2,
    number_of_reviews_on_the_property == "4" ~ 4,
    number_of_reviews_on_the_property == "2" ~ 2,
    number_of_reviews_on_the_property == "0" ~ 0,
    number_of_reviews_on_the_property == "3" ~ 3,
    number_of_reviews_on_the_property == "1" ~ 1
  )) %>% 
  mutate(treat = if_else(online_visits == 'Yes', 1, 0))

common_property_id <- intersect(
  property %>% pull(property_id) %>% unique(),
  metrics %>% pull(property_id) %>% unique()
  )

property <- property %>% 
  filter(property_id %in% c(common_property_id))

property_metrics <- metrics %>% 
  left_join(property, by = 'property_id') 
```

## 3. Exploratory Data Analysis

### 3.1. Number of Properties by Location and Online Visit Status

```{r num_prop_location}
p <- property %>% 
  group_by(location, online_visits) %>% 
  tally() %>% 
  ungroup() %>% 
  dplyr::rename(`Online Visits` = online_visits) %>% 
  ggplot(aes(x = location, y = n, fill = `Online Visits`, label = n)) +
  geom_col(position = 'dodge') +
  geom_text(position = position_dodge(width = 0.9), vjust = -1) +
  ylim(0, 650) +
  ylab('Location') +
  xlab('Number of Property') +
  theme_hc() +
  ggtitle('Number of Properties by Location')

print(p)
ggsave(file.path(here::here(), 'fig/01_num_prop_location.png'), p)
```

### 3.2. Mean Ratings and Mean Number of Reviews by Online Visit Status

```{r mean_ratings_and_number_of_ratings}
p <- property %>% 
  group_by(online_visits) %>% 
  summarize(mean_rating = mean(avg_review_rating_num),
            mean_num_reviews = mean(number_of_reviews_on_the_property_num)) %>% 
  ungroup() %>% 
  dplyr::rename(`Online Visits` = online_visits) %>% 
  gather(key = 'metrics', value = 'value', -`Online Visits`) %>% 
  mutate(metrics = if_else(metrics == 'mean_rating', "Average Rating", "Average Number of Rating")) %>% 
  ggplot(aes(x = metrics, y = value, fill = `Online Visits`, label = round(value, 2))) +
  geom_col(position = 'dodge') +
  geom_text(position = position_dodge(width = 0.9), vjust = -1) +
  xlab('Metrics') +
  ylab('Value') +
  theme_hc() +
  ggtitle('Mean Ratings and Mean Number of Reviews by Online Visit Status') +
  ylim(0, 15)

print(p)
ggsave(file.path(here::here(), 'fig/02_avg_rating_review_by_tour.png'), p)
```

There is weak evidence that the properties in the online visit group has higher average ratings than the non-online visit group.

```{r ttest_ratings}
continuous_vars <- c('avg_review_rating_num', 'number_of_reviews_on_the_property_num')
map(continuous_vars, vectorize_ttest_for_property)
```

### 3.3. Property Size by Online Visit Status

```{r prop_size_by_online_visit}
p <- property %>% 
  group_by(online_visits) %>% 
  summarize(`Avg # of Bedrooms` = mean(bedrooms),
            `Avg # of Bathrooms` = mean(bathrooms),
            `Avg Maximum Occupancy` = mean(maximum_occupancy)) %>% 
  ungroup() %>% 
  dplyr::rename(`Online Visits` = online_visits) %>% 
  gather(key = 'metrics', value = 'value', -`Online Visits`) %>% 
  ggplot(aes(x = metrics, y = value, fill = `Online Visits`, label = round(value, 2))) +
  geom_col(position = 'dodge') +
  geom_text(position = position_dodge(width = 0.9), vjust = -1) +
  xlab('Metrics') +
  ylab('Value') +
  theme_hc() +
  ggtitle('Average Property Size by Virtual Tour') +
  ylim(0, 10)

print(p)
ggsave(file.path(here::here(), 'fig/03_prop_size_by_online_visit.png'), p)
```

With p-values > 0.05, none of these variables are that different between the online visit group and non-online visit group.

```{r ttest_size}
continuous_vars <- c('bedrooms', 'bathrooms', 'maximum_occupancy')
map(continuous_vars, vectorize_ttest_for_property)
```

### 3.4. 

```{r IB_and PP_type_by_tour}
p <- property %>% 
  group_by(online_visits) %>% 
  summarize(instant_booking_enabled = mean(instant_booking_enabled),
            premier_partner_badge = mean(premier_partner_badge)) %>% 
  ungroup() %>% 
  dplyr::rename(`Online Visits` = online_visits) %>% 
  gather(key = 'metrics', value = 'value', -`Online Visits`) %>% 
  ggplot(aes(x = metrics, y = value, fill = `Online Visits`, label = scales::percent(value, 0.01))) +
  geom_col(position = 'dodge') +
  geom_text(position = position_dodge(width = 0.9), vjust = -1) +
  xlab('Metrics') +
  ylab('Value') +
  theme_hc() +
  ggtitle('Percentage of Properties with Instant Booking and Premier Partner Badge') +
  ylim(0, 0.4)

print(p)
ggsave(file.path(here::here(), 'fig/04_IB_and PP_type_by_tour.png'), p)
```







